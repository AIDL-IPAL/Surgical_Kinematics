; Instrument configuration file for pose estimation.
; Contains the variable configurations for surgical instruments used in pose estimation training/inference.

CLS_NAMES = [
  "clip applier",
  "grasper",
  "cautery hook",
  "scissors",
  "sealer",
  "stapler"
]

# Class index lookup (0-based)
CLS_INDEX = {
  "clip applier": 0,
  "grasper": 1,
  "cautery hook": 2,
  "scissors": 3,
  "sealer": 4,
  "stapler": 5
}

# Global transform defaults (used unless overridden per-instrument)
GLOBAL_TRANSFORM_DEFAULTS = {
  "mode_default": "auto",         # "2d"|"3d"|"auto"
  "emit_relative": True,
  "emit_r6d": True,
  "dt_default": 0.0333,
  "normalization": {
    "pixel_to_ndc": True,
    "local_scale": "wrist_tip"     # ||wrist_mid - tip||
  },
  "quality": {
    "min_conf": 0.30,
    "min_kps_for_orientation": 2,
    "min_kps_for_angle": 2         # require both jaw kps for theta
  },
  "lifting_3d": {
    "require_intrinsics": True,
    "require_depth": False,
    "require_depth_for": ["tip", "wrist", "shaft"]
  },
  "orientation_strategies": {
    "forward_axis": "wrist_to_tip",      # ẑ = normalize(T - W)
    "jaw_axis_2d": "jaw_upper_to_lower", # else perp_to_shaft
    "fallback_2d_perp": True
  }
}

# Role schema notes:
# - tip is computed as midpoint(jaw_upper, jaw_lower) if both exist,
#   otherwise can be overridden by "tooltip_role".
# - wrist is midpoint(wrist-1, wrist-2) if both exist, else whichever exists.
# - shaft axis (2D): normalize(wrist - shaft); jaw axis (2D): normalize(jaw_upper - jaw_lower) if available.
# - has_jaw=False disables θ_open; will emit normalized spread ϕ only if a jaw pair exists.

INSTRUMENTS = {
  "grasper": {
    "cls_idx": CLS_INDEX["grasper"],
    "kp_order": ["jaw_upper", "jaw_lower", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "jaw_upper": "jaw_upper",
      "jaw_lower": "jaw_lower",
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft"
    },
    "has_jaw": True,
    "opening": {
      "mode": "angle",                  # uses hinge_radius_mm
      "hinge_radius_mm": 6.0,           # calibration_r (pivot -> tracked jaw kp)
      "theta_bounds_deg": [0.0, 65.0],  # renamed for clarity
      "clip_to_bounds": True
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  },

  "scissors": {
    "cls_idx": CLS_INDEX["scissors"],
    "kp_order": ["jaw_upper", "jaw_lower", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "jaw_upper": "jaw_upper",
      "jaw_lower": "jaw_lower",
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft"
    },
    "has_jaw": True,
    "opening": {
      "mode": "angle",
      "hinge_radius_mm": 7.5,
      "theta_bounds_deg": [0.0, 50.0],
      "clip_to_bounds": True
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  },

  "clip applier": {
    "cls_idx": CLS_INDEX["clip applier"],
    "kp_order": ["jaw_upper", "jaw_lower", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "jaw_upper": "jaw_upper",
      "jaw_lower": "jaw_lower",
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft"
    },
    "has_jaw": True,
    "opening": {
      "mode": "angle",
      "hinge_radius_mm": 4.0,
      "theta_bounds_deg": [0.0, 35.0],
      "clip_to_bounds": True
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  },

  "sealer": {
    "cls_idx": CLS_INDEX["sealer"],
    "kp_order": ["jaw_upper", "jaw_lower", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "jaw_upper": "jaw_upper",
      "jaw_lower": "jaw_lower",
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft"
    },
    "has_jaw": True,
    "opening": {
      "mode": "angle",
      "hinge_radius_mm": 6.0,
      "theta_bounds_deg": [0.0, 40.0],
      "clip_to_bounds": True
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  },

  "stapler": {
    "cls_idx": CLS_INDEX["stapler"],
    "kp_order": ["jaw_upper", "jaw_lower", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "jaw_upper": "jaw_upper",
      "jaw_lower": "jaw_lower",
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft"
    },
    "has_jaw": True,
    "opening": {
      "mode": "spread",                 # map normalized spread -> θ with small LUT/linear fit
      "hinge_radius_mm": None,
      "theta_bounds_deg": [0.0, 60.0],
      "clip_to_bounds": True
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  },

  "cautery hook": {
    "cls_idx": CLS_INDEX["cautery hook"],
    "kp_order": ["tip", "wrist-1", "wrist-2", "shaft"],
    "roles": {
      "tooltip_role": "tip",            # explicit
      "wrist-1": "wrist-1",
      "wrist-2": "wrist-2",
      "shaft": "shaft",
      "jaw_upper": None,
      "jaw_lower": None
    },
    "has_jaw": False,
    "opening": {
      "mode": None,
      "hinge_radius_mm": None,
      "theta_bounds_deg": None,
      "clip_to_bounds": False
    },
    "transform": {
      **GLOBAL_TRANSFORM_DEFAULTS
    }
  }
}
